module qls/generate

imports
	
	libstratego-lib
	libstratego-gpp
	libstratego-aterm
	lib/editor-common.generated
	lib/analysis-library

	include/QL
	lib/webdsl/WebDSL

  generate
  store
	
rules
	
	compile-qls: 
		QLS(_, page*) ->
		webdsl |[
			x
			
			//globals
			
			//p1
			//p2
			//...
			
			//root page
		]|
		where
			fref* := <mapconcat(qls-page-forms); make-set> page*;
			x     := <map(compile-qls-entity)> fref*
			// create globals for referenced forms
			// compile each page
			// create a root page that navigates to the first page
  	
  compile-qls-entity:
  	FormRef(x_formID) -> |[ entity x_formID { ebd* } ]|
  	where
	  	ebd* := <qls-get-questions; collect-all(compile-ql-entity-part)> x_formID
	
	compile-qls-page:
		|[ page str1 for fref* { pp* } ]| -> 
		webdsl |[ 
			page page1() {
				
			}
		]|
	  where
	  	id
	  	// create page name
	  	// for each part
	  	//   if it is a question reference, compile it
	  	//   if it is a section/subsection, compile it to a webdsl section/subsection and nest question references inside it
	  	
	compile-qls-part:
		|[ qid { s* } ]| -> <id>
		where
			id
			// get label, type and condition from the index
			// if there is a condition, compile that first
			// compile question, nested into the condition if needed
			
rules // Projections
	
  qls-page-forms:
  	Page(_, fref*, _) -> fref*
	
rules // Index
	
	qls-get-questions =
		index-get-data-all(|Questions());
		map(index-get-data(|AST()))

		